name: Build Android APK

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:  # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    # –®–∞–≥ 1: –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥
    - name: Checkout code
      uses: actions/checkout@v3
      
    # –®–∞–≥ 2: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Node.js
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        
    # –®–∞–≥ 3: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    - name: Install dependencies
      run: |
        npm install
        npm list
        
    # –®–∞–≥ 4: –°–æ–±–∏—Ä–∞–µ–º PWA
    - name: Build PWA
      run: |
        npm run build
        ls -la dist/
        
    # –®–∞–≥ 5: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Java (–Ω—É–∂–Ω–∞ –¥–ª—è Android)
    - name: Setup Java
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'
        
    # –®–∞–≥ 6: –°–æ–±–∏—Ä–∞–µ–º APK —á–µ—Ä–µ–∑ Capacitor
    - name: Build Android APK
      run: |
        echo "üì± –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Capacitor..."
        npm install @capacitor/core @capacitor/cli @capacitor/android
        
        echo "‚öôÔ∏è –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Capacitor..."
        npx cap init "–í–µ—Ç–µ—Ä–∏–Ω–∞—Ä–Ω—ã–π –ê—Ç–ª–∞—Å" "com.vetanatlas.app" --web-dir dist
        
        echo "üì¶ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ Android –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã..."
        npx cap add android
        
        echo "üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è..."
        npx cap sync
        
        echo "üèóÔ∏è –°–±–æ—Ä–∫–∞ APK..."
        cd android
        chmod +x ./gradlew
        ./gradlew assembleDebug
        
        echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ APK..."
        ls -la app/build/outputs/apk/debug/
        
    # –®–∞–≥ 7: –ó–∞–≥—Ä—É–∂–∞–µ–º –≥–æ—Ç–æ–≤—ã–π APK
    - name: Upload APK
      uses: actions/upload-artifact@v3
      with:
        name: vet-anatlas-apk
        path: android/app/build/outputs/apk/debug/app-debug.apk
        retention-days: 30